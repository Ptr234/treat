import express from 'express';
import jwt from 'jsonwebtoken';
import Joi from 'joi';
import { User } from '../models/User.js';
import { EmailVerification } from '../models/EmailVerification.js';
import emailService from '../services/emailService.js';
import googleOAuthService from '../services/googleOAuthService.js';

const router = express.Router();

// Validation schemas
const registerSchema = Joi.object({
  email: Joi.string().email().required(),
  password: Joi.string().min(8).required(),
  confirmPassword: Joi.string().valid(Joi.ref('password')).required().messages({
    'any.only': 'Passwords do not match'
  }),
  firstName: Joi.string().min(2).max(100).required(),
  lastName: Joi.string().min(2).max(100).required(),
  phone: Joi.string().optional()
});

const verifyEmailSchema = Joi.object({
  email: Joi.string().email().required(),
  code: Joi.string().length(6).required(),
  type: Joi.string().valid('registration', 'login').default('registration')
});

const googleAuthSchema = Joi.object({
  idToken: Joi.string().required()
});

const resendCodeSchema = Joi.object({
  email: Joi.string().email().required(),
  type: Joi.string().valid('registration', 'login').default('registration')
});

const loginSchema = Joi.object({
  email: Joi.string().email().required(),
  password: Joi.string().required()
});

// Generate JWT token
const generateToken = (userId) => {
  return jwt.sign({ userId }, process.env.JWT_SECRET, {
    expiresIn: process.env.JWT_EXPIRES_IN || '7d'
  });
};

// Register new user (Step 1: Create user and send verification code)
router.post('/register', async (req, res, next) => {
  try {
    const { error, value } = registerSchema.validate(req.body);
    if (error) {
      return res.status(400).json({
        success: false,
        message: 'Validation error',
        errors: error.details.map(detail => detail.message)
      });
    }

    // Check if user already exists
    const existingUser = await User.findByEmail(value.email);
    if (existingUser && existingUser.is_verified) {
      return res.status(409).json({
        success: false,
        message: 'User with this email already exists'
      });
    }

    // If user exists but is not verified, delete the old record
    if (existingUser && !existingUser.is_verified) {
      await User.deleteById(existingUser.id);
    }

    // Create new user (unverified)
    const user = await User.create({ ...value, is_verified: false });
    
    // Generate and send verification code
    const verificationCode = emailService.generateVerificationCode();
    await EmailVerification.create({
      email: value.email,
      code: verificationCode,
      type: 'registration',
      userId: user.id
    });

    await emailService.sendVerificationEmail(value.email, verificationCode, 'registration');

    res.status(201).json({
      success: true,
      message: 'Registration initiated. Please check your email for verification code.',
      data: {
        email: value.email,
        requiresVerification: true
      }
    });
  } catch (error) {
    next(error);
  }
});

// Login user (Step 1: Verify credentials and send verification code)
router.post('/login', async (req, res, next) => {
  try {
    const { error, value } = loginSchema.validate(req.body);
    if (error) {
      return res.status(400).json({
        success: false,
        message: 'Validation error',
        errors: error.details.map(detail => detail.message)
      });
    }

    // Find user by email
    const user = await User.findByEmail(value.email);
    if (!user) {
      return res.status(401).json({
        success: false,
        message: 'Invalid email or password'
      });
    }

    // Check if user is verified
    if (!user.is_verified) {
      return res.status(401).json({
        success: false,
        message: 'Account not verified. Please complete registration first.',
        requiresRegistration: true
      });
    }

    // Verify password
    const isValidPassword = await User.verifyPassword(value.password, user.password_hash);
    if (!isValidPassword) {
      return res.status(401).json({
        success: false,
        message: 'Invalid email or password'
      });
    }

    // Generate and send verification code
    const verificationCode = emailService.generateVerificationCode();
    await EmailVerification.create({
      email: value.email,
      code: verificationCode,
      type: 'login',
      userId: user.id
    });

    await emailService.sendVerificationEmail(value.email, verificationCode, 'login');

    res.json({
      success: true,
      message: 'Verification code sent to your email',
      data: {
        email: value.email,
        requiresVerification: true
      }
    });
  } catch (error) {
    next(error);
  }
});

// Verify token
router.get('/verify', async (req, res, next) => {
  try {
    const token = req.headers.authorization?.split(' ')[1];
    if (!token) {
      return res.status(401).json({
        success: false,
        message: 'No token provided'
      });
    }

    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    const user = await User.findById(decoded.userId);
    
    if (!user) {
      return res.status(401).json({
        success: false,
        message: 'Invalid token'
      });
    }

    res.json({
      success: true,
      data: {
        user: {
          id: user.id,
          email: user.email,
          firstName: user.first_name,
          lastName: user.last_name,
          role: user.role
        }
      }
    });
  } catch (error) {
    next(error);
  }
});

// Verify email code (Step 2: Complete registration or login)\nrouter.post('/verify-email', async (req, res, next) => {\n  try {\n    const { error, value } = verifyEmailSchema.validate(req.body);\n    if (error) {\n      return res.status(400).json({\n        success: false,\n        message: 'Validation error',\n        errors: error.details.map(detail => detail.message)\n      });\n    }\n\n    // Find verification record\n    const verification = await EmailVerification.findByEmailAndCode(\n      value.email, \n      value.code, \n      value.type\n    );\n\n    if (!verification) {\n      return res.status(400).json({\n        success: false,\n        message: 'Invalid or expired verification code'\n      });\n    }\n\n    // Mark verification as completed\n    await EmailVerification.markAsVerified(verification.id);\n\n    if (value.type === 'registration') {\n      // Mark user as verified and send welcome email\n      const user = await User.markAsVerified(verification.user_id);\n      await emailService.sendWelcomeEmail(user.email, user.first_name);\n      \n      const token = generateToken(user.id);\n      \n      res.json({\n        success: true,\n        message: 'Registration completed successfully',\n        data: {\n          user: {\n            id: user.id,\n            email: user.email,\n            firstName: user.first_name,\n            lastName: user.last_name,\n            role: user.role\n          },\n          token\n        }\n      });\n    } else {\n      // Login verification\n      const user = await User.findById(verification.user_id);\n      const token = generateToken(user.id);\n      \n      res.json({\n        success: true,\n        message: 'Login successful',\n        data: {\n          user: {\n            id: user.id,\n            email: user.email,\n            firstName: user.first_name,\n            lastName: user.last_name,\n            role: user.role\n          },\n          token\n        }\n      });\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n// Google OAuth authentication\nrouter.post('/google', async (req, res, next) => {\n  try {\n    const { error, value } = googleAuthSchema.validate(req.body);\n    if (error) {\n      return res.status(400).json({\n        success: false,\n        message: 'Validation error',\n        errors: error.details.map(detail => detail.message)\n      });\n    }\n\n    // Verify Google ID token\n    const googleUser = await googleOAuthService.verifyIdToken(value.idToken);\n    \n    if (!googleUser.emailVerified) {\n      return res.status(400).json({\n        success: false,\n        message: 'Google account email is not verified'\n      });\n    }\n\n    // Check if user exists\n    let user = await User.findByEmail(googleUser.email);\n    \n    if (user) {\n      // User exists - generate verification code for login\n      const verificationCode = emailService.generateVerificationCode();\n      await EmailVerification.create({\n        email: googleUser.email,\n        code: verificationCode,\n        type: 'login',\n        userId: user.id\n      });\n\n      await emailService.sendVerificationEmail(googleUser.email, verificationCode, 'login');\n      \n      res.json({\n        success: true,\n        message: 'Verification code sent to your email',\n        data: {\n          email: googleUser.email,\n          requiresVerification: true,\n          isExistingUser: true\n        }\n      });\n    } else {\n      // New user - create account and generate verification code\n      const newUser = await User.create({\n        email: googleUser.email,\n        password: 'google-oauth-' + Math.random().toString(36),\n        firstName: googleUser.firstName,\n        lastName: googleUser.lastName,\n        is_verified: false\n      });\n      \n      const verificationCode = emailService.generateVerificationCode();\n      await EmailVerification.create({\n        email: googleUser.email,\n        code: verificationCode,\n        type: 'registration',\n        userId: newUser.id\n      });\n\n      await emailService.sendVerificationEmail(googleUser.email, verificationCode, 'registration');\n      \n      res.status(201).json({\n        success: true,\n        message: 'Account created with Google. Please check your email for verification code.',\n        data: {\n          email: googleUser.email,\n          requiresVerification: true,\n          isExistingUser: false\n        }\n      });\n    }\n  } catch (error) {\n    next(error);\n  }\n});\n\n// Resend verification code\nrouter.post('/resend-code', async (req, res, next) => {\n  try {\n    const { error, value } = resendCodeSchema.validate(req.body);\n    if (error) {\n      return res.status(400).json({\n        success: false,\n        message: 'Validation error',\n        errors: error.details.map(detail => detail.message)\n      });\n    }\n\n    // Check if there's a pending verification\n    const pendingVerification = await EmailVerification.findPendingByEmail(value.email, value.type);\n    if (!pendingVerification) {\n      return res.status(400).json({\n        success: false,\n        message: 'No pending verification found for this email'\n      });\n    }\n\n    // Check rate limit (wait at least 1 minute)\n    const remainingTime = await EmailVerification.getRemainingTime(value.email, value.type);\n    if (remainingTime > 540) { // 9 minutes remaining = sent less than 1 minute ago\n      return res.status(429).json({\n        success: false,\n        message: 'Please wait before requesting a new code',\n        remainingSeconds: Math.ceil(remainingTime - 540)\n      });\n    }\n\n    // Generate and send new verification code\n    const verificationCode = emailService.generateVerificationCode();\n    await EmailVerification.create({\n      email: value.email,\n      code: verificationCode,\n      type: value.type,\n      userId: pendingVerification.user_id\n    });\n\n    await emailService.sendVerificationEmail(value.email, verificationCode, value.type);\n\n    res.json({\n      success: true,\n      message: 'New verification code sent to your email'\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\nexport default router;