class r{constructor(){this.initialized=!1,this.events=[],this.userSession=null,this.performanceMetrics=new Map,this.businessMetrics=new Map,this.maxEvents=1e3,this.batchSize=50,this.flushInterval=3e4,this.isProduction=!0,this.init()}init(){typeof window>"u"||(this.userSession=this.createUserSession(),this.setupPerformanceTracking(),this.setupUserBehaviorTracking(),this.startEventBatching(),this.initialized=!0,this.trackPageView(window.location.pathname))}initialize(e={}){this.isProduction&&(e.ga4MeasurementId&&this.loadGoogleAnalytics(e.ga4MeasurementId),this.trackPageView(window.location.pathname),this.trackPerformanceMetrics(),this.trackEngagement())}loadGoogleAnalytics(e){const t=document.createElement("script");t.async=!0,t.src=`https://www.googletagmanager.com/gtag/js?id=${e}`,document.head.appendChild(t),t.onload=()=>{window.dataLayer=window.dataLayer||[];function n(){dataLayer.push(arguments)}n("js",new Date),n("config",e,{user_id:this.userId,session_id:this.sessionId,send_page_view:!1}),window.gtag=n}}trackPageView(e,t=document.title){this.isProduction&&window.gtag&&window.gtag("event","page_view",{page_title:t,page_location:window.location.href,page_path:e}),this.logEvent("page_view",{path:e,title:t})}trackEvent(e,t={},n={}){if(!this.initialized)return;const i={id:this.generateEventId(),event:e,properties:{...t,page:window.location.pathname,pageTitle:document.title,timestamp:Date.now(),sessionId:this.userSession?.sessionId,userId:this.userSession?.userId,deviceType:this.userSession?.deviceType,browser:this.userSession?.browser},metadata:{url:window.location.href,referrer:document.referrer,userAgent:navigator.userAgent,timestamp:new Date().toISOString(),timeOnPage:this.getTimeOnPage(),scrollPosition:this.getScrollPosition(),...n}};return this.events.push(i),this.updateUserActivity(),this.isCriticalEvent(e)&&this.processCriticalEvent(i),this.events.length>this.maxEvents&&this.events.splice(0,this.events.length-this.maxEvents),this.isProduction&&window.gtag&&window.gtag("event",e,t),this.logEvent(e,t),i.id}generateEventId(){return`evt_${Date.now()}_${Math.random().toString(36).substr(2,8)}`}isCriticalEvent(e){return["error_occurred","payment_initiated","form_submit","user_registration","security_violation","api_failure"].includes(e)}processCriticalEvent(e){this.sendToAnalyticsService([e],!0)}trackServiceView(e,t){this.trackEvent("view_service",{service_name:e,service_category:t,content_type:"service"})}trackInvestmentView(e,t){this.trackEvent("view_investment",{investment_name:e,investment_category:t,content_type:"investment"})}trackCalculatorUse(e,t){this.trackEvent("use_calculator",{calculator_type:e,calculation_result:t})}trackFormSubmission(e,t=!0){this.trackEvent("form_submit",{form_name:e,success:t})}trackDownload(e,t="document"){this.trackEvent("file_download",{file_name:e,file_category:t})}trackSearch(e,t=0){this.trackEvent("search",{search_term:e,result_count:t})}trackError(e,t="error"){this.trackEvent("error",{error_message:e,error_level:t,page_path:window.location.pathname})}trackPerformanceMetrics(){this.isProduction&&("PerformanceObserver"in window&&new PerformanceObserver(t=>{t.getEntries().forEach(n=>{n.entryType==="paint"&&n.name==="first-contentful-paint"&&this.trackEvent("performance_metric",{metric_name:"FCP",metric_value:Math.round(n.startTime),metric_unit:"ms"})})}).observe({entryTypes:["paint"]}),window.addEventListener("load",()=>{const e=Date.now()-(window.pageStartTime||Date.now());this.trackEvent("performance_metric",{metric_name:"page_load_time",metric_value:e,metric_unit:"ms"})}))}getUserId(){let e=localStorage.getItem("osc_user_id");return e||(e=`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("osc_user_id",e)),e}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}logEvent(e,t){this.isProduction}trackEngagement(){let e=0,t=!0,n=Date.now();const i=()=>{if(t){const s=Date.now();e+=s-n,n=s}};document.addEventListener("visibilitychange",()=>{document.hidden?(i(),t=!1):(t=!0,n=Date.now())}),["mousedown","keydown","scroll","touchstart"].forEach(s=>{document.addEventListener(s,()=>{n=Date.now()},{passive:!0})}),setInterval(()=>{i(),e>0&&(this.trackEvent("user_engagement",{engagement_time_msec:e}),e=0)},3e4),window.addEventListener("beforeunload",()=>{i(),e>0&&this.trackEvent("user_engagement",{engagement_time_msec:e})})}createUserSession(){const e=this.generateSessionId(),t=this.getUserId();return{sessionId:e,userId:t,startTime:Date.now(),userAgent:navigator.userAgent,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,screenResolution:`${screen.width}x${screen.height}`,viewportSize:`${window.innerWidth}x${window.innerHeight}`,deviceType:this.getDeviceType(),browser:this.getBrowserInfo(),referrer:document.referrer,utmSource:this.getUtmParameters(),country:"UG",lastActivity:Date.now()}}getDeviceType(){const e=window.innerWidth;return e<768?"mobile":e<1024?"tablet":"desktop"}getBrowserInfo(){const e=navigator.userAgent;let t="Unknown";return e.includes("Chrome")?t="Chrome":e.includes("Firefox")?t="Firefox":e.includes("Safari")?t="Safari":e.includes("Edge")?t="Edge":e.includes("IE")&&(t="Internet Explorer"),t}getUtmParameters(){const e=new URLSearchParams(window.location.search);return{source:e.get("utm_source"),medium:e.get("utm_medium"),campaign:e.get("utm_campaign"),term:e.get("utm_term"),content:e.get("utm_content")}}trackBusinessAction(e,t={}){this.trackEvent("business_action",{action:e,context:t,businessContext:this.getBusinessContext()}),this.updateBusinessMetrics(e,t)}getBusinessContext(){return{currentService:this.getCurrentService(),userJourney:this.getUserJourney(),conversionFunnel:this.getConversionFunnelStage(),userSegment:this.getUserSegment()}}getCurrentService(){const e=window.location.pathname;return e.includes("calculator")?"tax_calculator":e.includes("registration")?"business_registration":e.includes("investment")?"investment_services":e.includes("roi")?"roi_calculator":e.includes("invoice")?"invoice_generator":"general"}getUserJourney(){return JSON.parse(localStorage.getItem("user_journey")||"[]").slice(-10)}getConversionFunnelStage(){const e=window.location.pathname;return e==="/"?"awareness":e.includes("services")||e.includes("investments")?"interest":e.includes("calculator")||e.includes("registration")?"consideration":e.includes("invoice")||e.includes("support")?"intent":"unknown"}getUserSegment(){const e=parseInt(localStorage.getItem("visit_count")||"1"),t=this.getTotalTimeOnSite();return e===1?"new_visitor":e<5?"returning_visitor":e>=5&&t>3e5?"engaged_user":e>=10?"loyal_user":"casual_visitor"}updateBusinessMetrics(e,t){const n=`${e}_${t.type||"general"}`,i=this.businessMetrics.get(n)||{count:0,lastUpdated:Date.now()};i.count++,i.lastUpdated=Date.now(),this.businessMetrics.set(n,i)}setupPerformanceTracking(){this.trackCoreWebVitals(),this.startPerformanceMonitoring()}trackCoreWebVitals(){this.observePerformanceEntry("paint",e=>{e.forEach(t=>{t.name==="first-contentful-paint"&&this.trackEvent("core_web_vital",{metric:"FCP",value:t.startTime,rating:this.rateMetric("FCP",t.startTime)})})})}observePerformanceEntry(e,t){if("PerformanceObserver"in window)try{new PerformanceObserver(i=>{t(i.getEntries())}).observe({type:e,buffered:!0})}catch{}}rateMetric(e,t){const i={FCP:{good:1800,needsImprovement:3e3},LCP:{good:2500,needsImprovement:4e3},CLS:{good:.1,needsImprovement:.25}}[e];return i?t<=i.good?"good":t<=i.needsImprovement?"needs-improvement":"poor":"unknown"}setupUserBehaviorTracking(){document.addEventListener("click",e=>{this.trackUserInteraction(e.target,"click",{x:e.clientX,y:e.clientY})}),document.addEventListener("visibilitychange",()=>{this.trackEvent("visibility_change",{hidden:document.hidden,visibilityState:document.visibilityState})}),window.addEventListener("beforeunload",()=>{this.trackEvent("page_unload",{timeOnPage:this.getTimeOnPage(),sessionDuration:Date.now()-(this.userSession?.startTime||Date.now())}),this.flushEvents(!0)})}trackUserInteraction(e,t,n={}){const i={tagName:e.tagName,className:e.className,id:e.id,textContent:e.textContent?.substring(0,100)};this.trackEvent("user_interaction",{action:t,element:i,...n})}getTimeOnPage(){return Date.now()-(window.pageStartTime||Date.now())}getTotalTimeOnSite(){return parseInt(localStorage.getItem("total_time_on_site")||"0")}getScrollPosition(){return Math.round(window.scrollY/(document.body.scrollHeight-window.innerHeight)*100)}updateUserActivity(){this.userSession&&(this.userSession.lastActivity=Date.now());const e=parseInt(localStorage.getItem("visit_count")||"0")+1;localStorage.setItem("visit_count",e.toString())}startPerformanceMonitoring(){}startEventBatching(){setInterval(()=>{this.flushEvents()},this.flushInterval)}flushEvents(e=!1){if(this.events.length===0)return;const t=e?this.events.splice(0):this.events.splice(0,this.batchSize);t.length>0&&this.sendToAnalyticsService(t)}sendToAnalyticsService(e,t=!1){const n=JSON.parse(localStorage.getItem("analytics_events")||"[]");n.push(...e),n.length>500&&n.splice(0,n.length-500),localStorage.setItem("analytics_events",JSON.stringify(n))}getAnalyticsDashboard(){const e=JSON.parse(localStorage.getItem("analytics_events")||"[]"),t=e.filter(n=>Date.now()-n.properties.timestamp<864e5);return{totalEvents:e.length,recentEvents:t.length,uniqueUsers:new Set(e.map(n=>n.properties.userId)).size,businessMetrics:Object.fromEntries(this.businessMetrics),sessionInfo:this.userSession}}}const a=new r;typeof window<"u"&&(window.analyticsManager=a,window.pageStartTime=Date.now());export{a};
