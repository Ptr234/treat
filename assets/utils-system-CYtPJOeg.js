class h{constructor(){this.errorLog=new Map,this.performanceMetrics=new Map,this.userContext=null,this.maxLogEntries=1e3,this.initializeErrorHandling()}initializeErrorHandling(){typeof window<"u"&&(window.addEventListener("error",this.handleGlobalError.bind(this)),window.addEventListener("unhandledrejection",this.handleUnhandledRejection.bind(this)),this.setupPerformanceMonitoring())}setUserContext(e){this.userContext={...e,timestamp:new Date().toISOString(),sessionId:this.generateSessionId(),userAgent:typeof navigator<"u"?navigator.userAgent:"unknown",url:typeof window<"u"?window.location.href:"unknown"}}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}handleGlobalError(e){const t={type:"GLOBAL_ERROR",message:e.message,filename:e.filename,lineNumber:e.lineno,columnNumber:e.colno,stack:e.error?.stack,timestamp:new Date().toISOString(),url:window.location.href,userContext:this.userContext};return this.logError(t),this.showUserFriendlyError("An unexpected error occurred. Our team has been notified."),!0}handleUnhandledRejection(e){const t={type:"UNHANDLED_REJECTION",message:e.reason?.message||String(e.reason),stack:e.reason?.stack,timestamp:new Date().toISOString(),url:window.location.href,userContext:this.userContext};this.logError(t),this.showUserFriendlyError("A network or processing error occurred. Please try again."),e.preventDefault()}logError(e,t="GENERAL"){const r=this.generateErrorId(),i={id:r,category:t,severity:this.determineSeverity(e),...e,browserInfo:this.getBrowserInfo(),deviceInfo:this.getDeviceInfo(),networkInfo:this.getNetworkInfo()};return this.errorLog.set(r,i),this.cleanupErrorLog(),this.formatConsoleError(i),this.sendToMonitoringService(i),i.severity==="CRITICAL"&&this.handleCriticalError(i),r}generateErrorId(){return`err_${Date.now()}_${Math.random().toString(36).substr(2,8)}`}determineSeverity(e){const t=[/network error/i,/failed to fetch/i,/security error/i,/permission denied/i],r=[/validation error/i,/timeout/i,/rate limit/i],i=e.message?.toLowerCase()||"";return t.some(s=>s.test(i))?"CRITICAL":r.some(s=>s.test(i))?"WARNING":e.type==="UNHANDLED_REJECTION"?"HIGH":"MEDIUM"}formatConsoleError(e){const t={CRITICAL:"color: #dc2626; background: #fee2e2; padding: 2px 6px; border-radius: 3px;",HIGH:"color: #ea580c; background: #fed7aa; padding: 2px 6px; border-radius: 3px;",WARNING:"color: #d97706; background: #fef3c7; padding: 2px 6px; border-radius: 3px;",MEDIUM:"color: #2563eb; background: #dbeafe; padding: 2px 6px; border-radius: 3px;"};e.stack,e.userContext}getBrowserInfo(){return typeof navigator>"u"?{}:{userAgent:navigator.userAgent,language:navigator.language,platform:navigator.platform,cookieEnabled:navigator.cookieEnabled,onLine:navigator.onLine,vendor:navigator.vendor}}getDeviceInfo(){return typeof window>"u"?{}:{screenWidth:window.screen?.width,screenHeight:window.screen?.height,windowWidth:window.innerWidth,windowHeight:window.innerHeight,devicePixelRatio:window.devicePixelRatio,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone}}getNetworkInfo(){if(typeof navigator>"u"||!navigator.connection)return{};const e=navigator.connection;return{effectiveType:e.effectiveType,downlink:e.downlink,rtt:e.rtt,saveData:e.saveData}}handleAPIError(e,t,r=null){const i={type:"API_ERROR",message:e.message,endpoint:t,requestData:r,status:e.status,statusText:e.statusText,timestamp:new Date().toISOString()};return this.logError(i,"API")}handleValidationError(e,t,r){const i={type:"VALIDATION_ERROR",message:`Validation failed for field '${e}' with value '${t}' against rule '${r}'`,field:e,value:t,rule:r,timestamp:new Date().toISOString()};return this.logError(i,"VALIDATION")}handleBusinessLogicError(e,t,r){const i={type:"BUSINESS_LOGIC_ERROR",message:`Business logic error in operation '${e}'`,operation:e,context:t,details:r,timestamp:new Date().toISOString()};return this.logError(i,"BUSINESS")}handleSecurityError(e,t){const r={type:"SECURITY_ERROR",message:`Security threat detected: ${e}`,threat:e,details:t,timestamp:new Date().toISOString()};return this.logError(r,"SECURITY"),this.alertSecurityTeam(r),r.id}handleCriticalError(e){this.showCriticalErrorNotification(e),this.attemptDataRecovery(),this.sendCriticalAlert(e)}showCriticalErrorNotification(e){if(typeof document>"u")return;const t=document.createElement("div");t.id="critical-error-notification",t.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: white;
      padding: 16px;
      z-index: 10002;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border-bottom: 3px solid #fbbf24;
    `,t.innerHTML=`
      <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 16px;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 24px;">üö®</span>
          <div style="text-align: left;">
            <div style="font-weight: bold; font-size: 16px;">Critical Error Detected</div>
            <div style="font-size: 14px; opacity: 0.9;">Error ID: ${e.id} | Our team has been automatically notified</div>
          </div>
        </div>
        <div style="display: flex; gap: 12px;">
          <button onclick="window.location.reload()" 
                  style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
            Reload Page
          </button>
          <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                  style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 4px;">
            √ó
          </button>
        </div>
      </div>
    `;const r=document.getElementById("critical-error-notification");r&&r.remove(),document.body.appendChild(t)}attemptDataRecovery(){try{const e=document.querySelectorAll("form"),t={};e.forEach((r,i)=>{const s=new FormData(r);t[`form_${i}`]=Object.fromEntries(s.entries())}),Object.keys(t).length>0&&localStorage.setItem(`emergency_backup_${Date.now()}`,JSON.stringify(t))}catch{}}showUserFriendlyError(e,t="error"){if(typeof document>"u")return;const r={error:{bg:"#fef2f2",border:"#fca5a5",text:"#991b1b"},warning:{bg:"#fffbeb",border:"#fcd34d",text:"#92400e"},info:{bg:"#eff6ff",border:"#93c5fd",text:"#1e40af"}},i=r[t]||r.error,s={error:"‚ùå",warning:"‚ö†Ô∏è",info:"‚ÑπÔ∏è"},n=document.createElement("div");n.style.cssText=`
      position: fixed;
      top: 80px;
      right: 20px;
      background: ${i.bg};
      border: 1px solid ${i.border};
      color: ${i.text};
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 10000;
      max-width: 400px;
      font-size: 14px;
      line-height: 1.5;
    `,n.innerHTML=`
      <div style="display: flex; align-items: flex-start; gap: 12px;">
        <span style="font-size: 18px; flex-shrink: 0;">${s[t]}</span>
        <div style="flex: 1;">
          <div style="font-weight: 600; margin-bottom: 4px;">
            ${t.charAt(0).toUpperCase()+t.slice(1)}
          </div>
          <div>${e}</div>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" 
                style="background: none; border: none; color: ${i.text}; font-size: 18px; cursor: pointer; opacity: 0.7; hover:opacity: 1;">
          √ó
        </button>
      </div>
    `,document.body.appendChild(n),setTimeout(()=>{n.parentElement&&n.remove()},8e3)}setupPerformanceMonitoring(){typeof PerformanceObserver>"u"||("PerformanceObserver"in window&&new PerformanceObserver(t=>{t.getEntries().forEach(r=>{r.entryType==="longtask"&&r.duration>100&&this.logError({type:"PERFORMANCE_WARNING",message:`Long task detected: ${r.duration}ms`,duration:r.duration,startTime:r.startTime},"PERFORMANCE")})}).observe({entryTypes:["longtask"]}),this.monitorMemoryUsage())}monitorMemoryUsage(){performance.memory&&setInterval(()=>{const e=performance.memory,t=Math.round(e.usedJSHeapSize/1048576),r=Math.round(e.jsHeapSizeLimit/1048576);t>r*.8&&this.logError({type:"MEMORY_WARNING",message:`High memory usage: ${t}MB / ${r}MB`,usedMemory:t,memoryLimit:r,percentage:Math.round(t/r*100)},"PERFORMANCE")},3e4)}sendToMonitoringService(e){const t=JSON.parse(localStorage.getItem("error_reports")||"[]");t.push({id:e.id,type:e.type,severity:e.severity,message:e.message,timestamp:e.timestamp}),t.length>100&&t.splice(0,t.length-100),localStorage.setItem("error_reports",JSON.stringify(t))}sendCriticalAlert(e){}alertSecurityTeam(e){}cleanupErrorLog(){if(this.errorLog.size>this.maxLogEntries){const e=Array.from(this.errorLog.entries());e.slice(0,e.length-this.maxLogEntries).forEach(([r])=>this.errorLog.delete(r))}}getErrorStats(){const e=Array.from(this.errorLog.values()),t={total:e.length,bySeverity:{},byCategory:{},byType:{},recent:e.filter(r=>Date.now()-new Date(r.timestamp).getTime()<36e5)};return e.forEach(r=>{t.bySeverity[r.severity]=(t.bySeverity[r.severity]||0)+1,t.byCategory[r.category]=(t.byCategory[r.category]||0)+1,t.byType[r.type]=(t.byType[r.type]||0)+1}),t}createErrorBoundary(){return{componentDidCatch:(e,t)=>{this.logError({type:"REACT_ERROR_BOUNDARY",message:e.message,stack:e.stack,componentStack:t.componentStack},"REACT")}}}exportErrorLogs(){const e=Array.from(this.errorLog.values()),t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),r=URL.createObjectURL(t),i=document.createElement("a");i.href=r,i.download=`error_logs_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)}}const m=new h;typeof window<"u"&&(window.errorManager=m);class g{constructor(){this.CSP_POLICY=this.generateCSPPolicy(),this.rateLimiter=new Map,this.suspiciousActivityLog=new Map,this.initializeSecurityHeaders()}generateCSPPolicy(){return{"default-src":"'self'","script-src":"'self' 'unsafe-inline' 'unsafe-eval' https://api.github.com","style-src":"'self' 'unsafe-inline' https://fonts.googleapis.com","font-src":"'self' https://fonts.gstatic.com","img-src":"'self' data: https: blob:","connect-src":"'self' https: wss:","media-src":"'self' https:","object-src":"'none'","base-uri":"'self'","form-action":"'self'","frame-ancestors":"'none'","upgrade-insecure-requests":!0}}initializeSecurityHeaders(){typeof document<"u"&&(this.setMetaTag("X-Content-Type-Options","nosniff"),this.setMetaTag("X-Frame-Options","SAMEORIGIN"),this.setMetaTag("X-XSS-Protection","1; mode=block"),this.setMetaTag("Referrer-Policy","strict-origin-when-cross-origin"),this.setMetaTag("Permissions-Policy","geolocation=(), camera=(), microphone=()"))}setMetaTag(e,t){const r=document.createElement("meta");r.httpEquiv=e,r.content=t,document.head.appendChild(r)}sanitizeInput(e,t="text"){if(typeof e!="string")return String(e||"");let r=e.trim();switch(t){case"email":if(r=r.replace(/[<>"'&]/g,""),!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r))throw new Error("Invalid email format");break;case"number":{const i=parseFloat(r);if(isNaN(i))throw new Error("Invalid number format");return i}case"phone":if(r=r.replace(/[^\d+-\s]/g,""),!/^\+?256[0-9]{9}$|^0[0-9]{9}$/.test(r.replace(/[\s-]/g,"")))throw new Error("Invalid Uganda phone number format");break;case"tin":if(r=r.replace(/[^\d]/g,""),!/^\d{10}$/.test(r))throw new Error("Invalid Uganda TIN format (must be 10 digits)");break;case"business_name":if(r=r.replace(/[<>"'&;]/g,""),r.length<2||r.length>100)throw new Error("Business name must be between 2-100 characters");break;case"amount":{const i=parseFloat(r.replace(/[,\s]/g,""));if(isNaN(i)||i<0||i>999999999999)throw new Error("Invalid amount (must be positive number under 1 trillion UGX)");return i}default:r=r.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/javascript:/gi,"").replace(/on\w+\s*=/gi,"").replace(/[<>"'&]/g,i=>({"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","&":"&amp;"})[i])}return r}checkRateLimit(e,t=100,r=6e4){const i=Date.now(),s=`${e}-${Math.floor(i/r)}`,n=this.rateLimiter.get(s)||{count:0,resetTime:i+r};if(n.count>=t)throw this.logSuspiciousActivity(e,"RATE_LIMIT_EXCEEDED",{requests:n.count,limit:t,windowMs:r}),new Error(`Rate limit exceeded. Try again in ${Math.ceil((n.resetTime-i)/1e3)} seconds`);return n.count++,this.rateLimiter.set(s,n),this.cleanupRateLimit(),{remaining:t-n.count,resetTime:n.resetTime}}cleanupRateLimit(){const e=Date.now();for(const[t,r]of this.rateLimiter.entries())r.resetTime<e&&this.rateLimiter.delete(t)}logSuspiciousActivity(e,t,r={}){const i={timestamp:new Date().toISOString(),identifier:e,type:t,data:r,userAgent:typeof navigator<"u"?navigator.userAgent:"unknown",url:typeof window<"u"?window.location.href:"unknown"},s=this.suspiciousActivityLog.get(e)||[];s.push(i),s.length>50&&s.splice(0,s.length-50),this.suspiciousActivityLog.set(e,s),s.length>5&&this.alertSecurityTeam(e,s)}alertSecurityTeam(e,t){typeof document<"u"&&this.showSecurityAlert(`Security Alert: Suspicious activity detected from ${e}`)}showSecurityAlert(e){const t=document.createElement("div");t.style.cssText=`
      position: fixed;
      top: 20px;
      right: 20px;
      background: #dc2626;
      color: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10001;
      max-width: 400px;
      font-weight: 500;
      border-left: 4px solid #fbbf24;
    `,t.innerHTML=`
      <div style="display: flex; align-items: center; gap: 8px;">
        <span>üö®</span>
        <span>${e}</span>
        <button onclick="this.parentElement.parentElement.remove()" 
                style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: auto;">
          √ó
        </button>
      </div>
    `,document.body.appendChild(t),setTimeout(()=>{t.parentElement&&t.remove()},1e4)}validateFileUpload(e,t={}){const{maxFiles:r,maxSize:i=5*1024*1024,allowedTypes:s=["image/jpeg","image/png","image/webp","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],_maxFiles:n=10}=t,o=[];if(e.size>i&&o.push(`File size ${this.formatBytes(e.size)} exceeds maximum ${this.formatBytes(i)}`),s.includes(e.type)||o.push(`File type ${e.type} not allowed. Allowed types: ${s.join(", ")}`),[/\.exe$/i,/\.bat$/i,/\.cmd$/i,/\.scr$/i,/\.pif$/i,/\.com$/i,/\.jar$/i,/\.js$/i,/\.vbs$/i,/\.php$/i,/<script/i,/javascript:/i,/onload=/i,/onerror=/i].some(c=>c.test(e.name))&&(o.push("File name contains suspicious patterns"),this.logSuspiciousActivity("file-upload","SUSPICIOUS_FILE_NAME",{fileName:e.name,fileType:e.type,fileSize:e.size})),o.length>0)throw new Error(`File validation failed: ${o.join(", ")}`);return!0}formatBytes(e){if(e===0)return"0 Bytes";const t=1024,r=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(t));return`${parseFloat((e/Math.pow(t,i)).toFixed(2))} ${r[i]}`}generateSecureToken(e=32){const t=new Uint8Array(e);return crypto.getRandomValues(t),Array.from(t,r=>r.toString(16).padStart(2,"0")).join("")}validateSession(e,t=36e5){if(!e||typeof e!="string")throw new Error("Invalid session token");if(!/^[a-f0-9]{64}$/i.test(e))throw this.logSuspiciousActivity("session","INVALID_TOKEN_FORMAT",{token:`${e.substring(0,8)}...`}),new Error("Invalid token format");const r=this.getStoredSession(e);if(!r)throw new Error("Session not found");if(Date.now()-r.created>t)throw this.removeStoredSession(e),new Error("Session expired");return r}getStoredSession(e){return JSON.parse(localStorage.getItem("secure_sessions")||"{}")[e]}setStoredSession(e,t){const r=JSON.parse(localStorage.getItem("secure_sessions")||"{}");r[e]={...t,created:Date.now(),lastAccessed:Date.now()},localStorage.setItem("secure_sessions",JSON.stringify(r))}removeStoredSession(e){const t=JSON.parse(localStorage.getItem("secure_sessions")||"{}");delete t[e],localStorage.setItem("secure_sessions",JSON.stringify(t))}performSecurityCheck(){const e={timestamp:new Date().toISOString(),checks:[],score:0,status:"unknown"},t=typeof window<"u"&&window.location.protocol==="https:";e.checks.push({name:"HTTPS Connection",status:t?"PASS":"FAIL",message:t?"Connection is secure":"Connection is not encrypted"}),t&&(e.score+=20);const r=typeof window<"u"&&window.isSecureContext;e.checks.push({name:"Secure Context",status:r?"PASS":"FAIL",message:r?"Running in secure context":"Not in secure context"}),r&&(e.score+=15),e.checks.push({name:"Content Security Policy",status:"INFO",message:"CSP configured in application"}),e.score+=15,e.checks.push({name:"Rate Limiting",status:"PASS",message:"Rate limiting active"}),e.score+=15,e.checks.push({name:"Input Sanitization",status:"PASS",message:"Input sanitization implemented"}),e.score+=15;const i=Array.from(this.suspiciousActivityLog.values()).flat().length;return e.checks.push({name:"Activity Monitoring",status:i>0?"WARN":"PASS",message:`${i} suspicious activities logged`}),e.score+=10,e.checks.push({name:"Session Security",status:"PASS",message:"Secure session management implemented"}),e.score+=10,e.score>=90?e.status="EXCELLENT":e.score>=75?e.status="GOOD":e.score>=50?e.status="FAIR":e.status="POOR",e}getSecurityMetrics(){return{rateLimitEntries:this.rateLimiter.size,suspiciousActivities:Array.from(this.suspiciousActivityLog.values()).flat().length,activeSessions:Object.keys(JSON.parse(localStorage.getItem("secure_sessions")||"{}")).length,lastSecurityCheck:localStorage.getItem("lastSecurityCheck"),securityScore:this.performSecurityCheck().score}}}const p=new g;typeof window<"u"&&(window.securityManager=p);class f{constructor(){this.metrics=new Map,this.healthChecks=new Map,this.alerts=new Map,this.performanceBaseline=new Map,this.systemStatus="unknown",this.monitoringInterval=null,this.initialized=!1,this.init()}init(){typeof window>"u"||(this.setupDefaultHealthChecks(),this.setupPerformanceMonitoring(),this.setupResourceMonitoring(),this.startMonitoring(),this.initialized=!0)}setupDefaultHealthChecks(){this.addHealthCheck("app_status",{name:"Application Status",check:()=>({status:document.readyState==="complete"?"healthy":"loading",details:{readyState:document.readyState,timestamp:Date.now()}}),interval:3e4,critical:!0}),this.addHealthCheck("network_status",{name:"Network Connectivity",check:async()=>{try{const e=await fetch("/manifest.json",{method:"HEAD",cache:"no-cache",signal:AbortSignal.timeout(5e3)});return{status:e.ok?"healthy":"degraded",details:{status:e.status,responseTime:Date.now(),online:navigator.onLine}}}catch{return{status:"unhealthy",details:{error:error.message,online:navigator.onLine}}}},interval:6e4,critical:!0}),this.addHealthCheck("service_worker_status",{name:"Service Worker Status",check:async()=>{if(!("serviceWorker"in navigator))return{status:"unavailable",details:{reason:"Service Worker not supported"}};try{const e=await navigator.serviceWorker.ready;return{status:e.active?"healthy":"degraded",details:{state:e.active?.state,scope:e.scope,updateViaCache:e.updateViaCache}}}catch{return{status:"unhealthy",details:{error:error.message}}}},interval:12e4,critical:!1}),this.addHealthCheck("cache_status",{name:"Cache System Status",check:async()=>{if(!("caches"in window))return{status:"unavailable",details:{reason:"Cache API not supported"}};try{const e=await caches.keys(),t=e.length;return{status:t>0?"healthy":"degraded",details:{totalCaches:t,cacheNames:e.slice(0,5),timestamp:Date.now()}}}catch{return{status:"unhealthy",details:{error:error.message}}}},interval:3e5,critical:!1}),this.addHealthCheck("memory_status",{name:"Memory Usage",check:()=>{if(!performance.memory)return{status:"unavailable",details:{reason:"Memory API not available"}};const e=performance.memory,t=Math.round(e.usedJSHeapSize/1048576),r=Math.round(e.jsHeapSizeLimit/1048576),i=Math.round(t/r*100);let s="healthy";return i>90?s="critical":i>75?s="warning":i>50&&(s="degraded"),{status:s,details:{usedMB:t,limitMB:r,usagePercent:i,totalMB:Math.round(e.totalJSHeapSize/1048576)}}},interval:6e4,critical:!1}),this.addHealthCheck("storage_status",{name:"Local Storage",check:()=>{try{const e="_monitoring_test_";return localStorage.setItem(e,"test"),localStorage.removeItem(e),{status:"healthy",details:{available:!0,usage:this.getStorageUsage()}}}catch{return{status:"unhealthy",details:{available:!1,error:error.message}}}},interval:3e5,critical:!1})}addHealthCheck(e,t){this.healthChecks.set(e,{...t,lastCheck:null,lastResult:null,checkCount:0,failureCount:0})}setupPerformanceMonitoring(){this.setupCoreWebVitalsMonitoring(),this.setupResourceTimingMonitoring(),this.setupNavigationTimingMonitoring(),this.setupErrorRateMonitoring()}setupCoreWebVitalsMonitoring(){this.observePerformance("paint",t=>{t.forEach(r=>{r.name==="first-contentful-paint"&&this.recordMetric("core_web_vitals","FCP",r.startTime,{rating:this.rateWebVital("FCP",r.startTime),url:window.location.href})})}),this.observePerformance("largest-contentful-paint",t=>{const r=t[t.length-1];this.recordMetric("core_web_vitals","LCP",r.startTime,{rating:this.rateWebVital("LCP",r.startTime),element:r.element?.tagName})}),this.observePerformance("first-input",t=>{t.forEach(r=>{this.recordMetric("core_web_vitals","FID",r.processingStart-r.startTime,{rating:this.rateWebVital("FID",r.processingStart-r.startTime),eventType:r.name})})});let e=0;this.observePerformance("layout-shift",t=>{t.forEach(r=>{r.hadRecentInput||(e+=r.value)}),this.recordMetric("core_web_vitals","CLS",e,{rating:this.rateWebVital("CLS",e)})})}setupResourceTimingMonitoring(){this.observePerformance("resource",e=>{e.forEach(t=>{(t.initiatorType==="fetch"||t.initiatorType==="xmlhttprequest")&&this.recordMetric("api_performance","response_time",t.duration,{url:t.name,method:"unknown",status:"unknown"})})})}setupNavigationTimingMonitoring(){this.observePerformance("navigation",e=>{e.forEach(t=>{this.recordMetric("navigation","page_load_time",t.duration,{type:t.type,redirectCount:t.redirectCount,dns:t.domainLookupEnd-t.domainLookupStart,tcp:t.connectEnd-t.connectStart,request:t.responseStart-t.requestStart,response:t.responseEnd-t.responseStart,dom:t.domContentLoadedEventEnd-t.domContentLoadedEventStart})})})}setupErrorRateMonitoring(){let e=0,t=0,r=0;const i=Date.now(),s=window.location.hostname!=="localhost"&&!window.location.hostname.includes("127.0.0.1");window.addEventListener("error",o=>{o.filename?.includes("node_modules")||o.message?.includes("Importing a module from")||o.message?.includes("dynamically imported module")||o.message?.includes("Loading chunk")||o.message?.includes("Loading CSS chunk")||!s&&o.message?.includes("development")||(e++,r++)}),window.addEventListener("unhandledrejection",o=>{o.reason?.message?.includes("dynamically imported module")||o.reason?.message?.includes("Failed to fetch")||o.reason?.message?.includes("Loading chunk")||o.reason?.stack?.includes("vite")||o.reason?.stack?.includes("dev-server")||(e++,r++)});const n=()=>{t++,r++};document.addEventListener("click",n,{passive:!0}),document.addEventListener("submit",n,{passive:!0}),document.addEventListener("input",n,{passive:!0}),setInterval(()=>{if((Date.now()-i)/6e4>2&&r>=20){const a=e/r*100;this.recordMetric("errors","error_rate",Math.max(0,Math.min(100,a))),r>1e3&&(e=Math.floor(e*.9),t=Math.floor(t*.9),r=e+t)}},3e4)}observePerformance(e,t){if("PerformanceObserver"in window)try{new PerformanceObserver(i=>{t(i.getEntries())}).observe({type:e,buffered:!0})}catch{}}rateWebVital(e,t){const i={FCP:{good:1800,needsImprovement:3e3},LCP:{good:2500,needsImprovement:4e3},FID:{good:100,needsImprovement:300},CLS:{good:.1,needsImprovement:.25}}[e];return i?t<=i.good?"good":t<=i.needsImprovement?"needs-improvement":"poor":"unknown"}setupResourceMonitoring(){if(window.addEventListener("online",()=>{this.recordMetric("network","status_change",1,{status:"online"})}),window.addEventListener("offline",()=>{this.recordMetric("network","status_change",0,{status:"offline"}),this.triggerAlert("network_offline","Network connection lost","critical")}),"getBattery"in navigator&&navigator.getBattery().then(e=>{const t=()=>{this.recordMetric("device","battery_level",e.level*100,{charging:e.charging,chargingTime:e.chargingTime,dischargingTime:e.dischargingTime})};e.addEventListener("levelchange",t),e.addEventListener("chargingchange",t),t()}),"connection"in navigator){const e=navigator.connection,t=()=>{this.recordMetric("network","connection_quality",this.getConnectionScore(e),{effectiveType:e.effectiveType,downlink:e.downlink,rtt:e.rtt,saveData:e.saveData})};e.addEventListener("change",t),t()}}getConnectionScore(e){return{"4g":100,"3g":75,"2g":50,"slow-2g":25}[e.effectiveType]||0}recordMetric(e,t,r,i={}){const s=`${e}.${t}`,n=Date.now();this.metrics.has(s)||this.metrics.set(s,{name:t,category:e,values:[],metadata:[],min:r,max:r,avg:r,count:0});const o=this.metrics.get(s);o.values.push({value:r,timestamp:n}),o.metadata.push({...i,timestamp:n}),o.count++,o.min=Math.min(o.min,r),o.max=Math.max(o.max,r),o.avg=o.values.reduce((a,c)=>a+c.value,0)/o.count,o.values.length>100&&(o.values.splice(0,o.values.length-100),o.metadata.splice(0,o.metadata.length-100)),this.checkMetricAlerts(s,r,i)}checkMetricAlerts(e,t,r){const i=window.location.hostname!=="localhost"&&!window.location.hostname.includes("127.0.0.1")&&!window.location.hostname.includes("192.168."),n={"core_web_vitals.LCP":{threshold:i?4e3:6e3,condition:"greater",severity:"warning"},"core_web_vitals.FCP":{threshold:i?3e3:5e3,condition:"greater",severity:"warning"},"core_web_vitals.CLS":{threshold:i?.25:.5,condition:"greater",severity:"warning"},memory_status:{threshold:90,condition:"greater",severity:"critical"},"errors.error_rate":{threshold:i?15:50,condition:"greater",severity:i?"warning":"info",minSamples:50}}[e];if(!n)return;if(e==="errors.error_rate"&&n.minSamples){const d=this.metrics.get(e);if(!d||d.count<n.minSamples)return}const o=n.condition==="greater"?t>n.threshold:t<n.threshold,a=`${e}_threshold`,c=this.alerts.get(a),u=Date.now();o&&(!c||u-c.timestamp>3e5)&&this.triggerAlert(a,`${e} exceeded threshold: ${Math.round(t*100)/100} > ${n.threshold}`,n.severity)}triggerAlert(e,t,r="warning",i={}){const s={id:e,message:t,severity:r,timestamp:Date.now(),metadata:i,acknowledged:!1};this.alerts.set(e,s),this.sendAlertToService(s),r==="critical"&&this.showCriticalAlert(s)}sendAlertToService(e){}showCriticalAlert(e){if(typeof document>"u"||!(window.location.hostname!=="localhost"&&!window.location.hostname.includes("127.0.0.1")&&!window.location.hostname.includes("192.168."))&&e.severity==="info"||e.id.includes("error_rate")&&e.severity!=="critical")return;const r=document.createElement("div"),i=e.severity==="critical"?"#dc2626":e.severity==="warning"?"#f59e0b":"#3b82f6";r.style.cssText=`
      position: fixed;
      top: 60px;
      right: 20px;
      background: ${i};
      color: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10001;
      max-width: 400px;
      font-size: 14px;
      border-left: 4px solid #fbbf24;
    `,r.innerHTML=`
      <div style="display: flex; align-items: center; gap: 12px;">
        <span style="font-size: 20px;">‚ö†Ô∏è</span>
        <div style="flex: 1;">
          <div style="font-weight: bold; margin-bottom: 4px;">System Alert</div>
          <div style="opacity: 0.9;">${e.message}</div>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" 
                style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">
          √ó
        </button>
      </div>
    `,document.body.appendChild(r),setTimeout(()=>{r.parentElement&&r.remove()},1e4)}startMonitoring(){this.monitoringInterval||(this.monitoringInterval=setInterval(async()=>{await this.runHealthChecks(),this.updateSystemStatus(),this.cleanupOldData()},3e4))}stopMonitoring(){this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null)}async runHealthChecks(){for(const[e,t]of this.healthChecks.entries())try{const r=await t.check();t.lastCheck=Date.now(),t.lastResult=r,t.checkCount++,(r.status==="unhealthy"||r.status==="critical")&&(t.failureCount++,t.critical&&this.triggerAlert(`health_check_${e}`,`Health check failed: ${t.name}`,"critical")),this.recordMetric("health_checks",e,this.getHealthScore(r.status),{status:r.status,details:r.details})}catch{t.failureCount++}}getHealthScore(e){return{healthy:100,degraded:75,warning:50,unhealthy:25,critical:0}[e]||0}updateSystemStatus(){const e=Array.from(this.healthChecks.values()).filter(r=>r.lastResult).map(r=>this.getHealthScore(r.lastResult.status));if(e.length===0){this.systemStatus="unknown";return}const t=e.reduce((r,i)=>r+i,0)/e.length;t>=90?this.systemStatus="healthy":t>=75?this.systemStatus="degraded":t>=50?this.systemStatus="warning":this.systemStatus="critical"}cleanupOldData(){const e=Date.now()-864e5;for(const[t,r]of this.alerts.entries())r.timestamp<e&&this.alerts.delete(t)}getStorageUsage(){return"storage"in navigator&&"estimate"in navigator.storage?navigator.storage.estimate().then(e=>({available:!0,quota:e.quota,usage:e.usage,usagePercent:Math.round(e.usage/e.quota*100)})).catch(()=>({available:!1})):{available:!1}}getSystemHealth(){const e={};for(const[t,r]of this.healthChecks.entries())e[t]={name:r.name,status:r.lastResult?.status||"unknown",lastCheck:r.lastCheck,checkCount:r.checkCount,failureCount:r.failureCount,details:r.lastResult?.details};return{systemStatus:this.systemStatus,timestamp:Date.now(),healthChecks:e,activeAlerts:Array.from(this.alerts.values()).filter(t=>!t.acknowledged),metrics:this.getMetricsSummary()}}getMetricsSummary(){const e={};for(const[t,r]of this.metrics.entries())e[t]={name:r.name,category:r.category,current:r.values[r.values.length-1]?.value,min:r.min,max:r.max,avg:Math.round(r.avg*100)/100,count:r.count};return e}exportMonitoringData(){const e={systemHealth:this.getSystemHealth(),metrics:Object.fromEntries(this.metrics),alerts:Object.fromEntries(this.alerts),exportTime:new Date().toISOString()},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),r=URL.createObjectURL(t),i=document.createElement("a");i.href=r,i.download=`osc_monitoring_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)}}const w=new f;typeof window<"u"&&(window.monitoringManager=w);export{m as e,p as s};
